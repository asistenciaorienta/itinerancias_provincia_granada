<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscador de Unidades e Itinerancias. Programa Andaluc√≠a Orienta. SAE Granada 2025-26</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* --- Layout general: body sin scroll, footer fijo --- */
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      margin: 0;
      background-color: #f6f8fa;
      font-family: 'Poppins', sans-serif;
      display: flex;
      flex-direction: column;
      color: #222;
    }

    /* header con logo izq y t√≠tulo centrado (viewport) */
    header{
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    header .logo{
      position:absolute;
      left:1rem;
      height:50px;
    }
    header .titulos{
      text-align:center;
    }
    header h1{
      margin:0;
      margin-top:0.5rem;
      font-size:1.55rem;
      color:#087021;
    }
    header h2{
      margin:0;
      margin-top:0.2rem;
      font-size:1.1rem;
      color:#222;
    }

    /* main ocupa el hueco entre header y footer */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      gap: 0.5rem;
      box-sizing: border-box;
      margin-top: 1.5rem;
    }

    /* buscador */
    #search {
      display: block;
      margin: 0 auto;
      padding: 0.6rem 0.9rem;
      width: 90%;
      max-width: 700px;
      border: 2px solid #0b6e4f;
      border-radius: 8px;
      font-size: 1rem;
      outline: none;
      box-sizing: border-box;
    }

    /* contenedor que envuelve ambas tablas (las coloca en columna) */
    .tables-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      min-height: 0; /* muy importante para que los children flex con overflow funcionen */
    }

    /* cabecera fija estilo th (fuera del scroll) */
    .headers-fijos {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background-color:#087021;
      color:white;
      font-weight:600;
      padding:8px;
      border-radius: 8px 8px 0 0;
      border-bottom:3px solid #065a19;
      align-items:center;
      gap: 0.25rem;
    }

    /* contenedor de datos: ESTE es el que hace scroll (uno por cada tabla) */
    .datos-scroll {
      background:white;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      border-radius: 0 0 8px 8px;
      padding: 6px 8px;
      overflow-y: auto;
      overflow-x: hidden;
      /* repartir verticalmente: cada contenedor ocupar√° parte del espacio disponible.
         Ajustamos proporciones con flex; si quieres uno m√°s alto que otro, ajusta flex. */
      flex: 1 1 0%;
      min-height: 0; /* crucial para que el overflow funcione en flex children */
    }

    /* filas estilo grid (cada fila corresponde a 7 columnas) */
    .fila {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      padding:8px;
      border-bottom:1px solid #e5e7eb;
      gap: 0.25rem;
      align-items:start;
      word-wrap:break-word;
    }
    .fila:nth-child(even) { background:#f9fafb; }
    .fila:hover { background:#f1f5f9; }

    /* peque√±os estilos para el t√≠tulo de cada bloque */
    .block-title {
      margin: 0 0 0.5rem 0;
      font-size: 0.95rem;
      color: #065a19;
      font-weight:700;
      text-transform: none;
    }

    /* mensaje sin resultados */
    .sin-resultados {
      padding:1rem;
      text-align:center;
      color:#666;
    }

    /* footer fijo */
    footer {
      background-color: #555555;
      color: #ffffff;
      text-align: center;
      padding: 0.9rem 1rem;
      font-size: 0.95rem;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 990;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 1rem;
      box-sizing: border-box;
    }
    footer .contacto-btn {
      margin-left: 1rem;
      background-color: #e9d87c;
      color: #333;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    footer .contacto-btn:hover { background-color: #d8c56a; }

    /* modal contacto */
    #modal-contacto {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    #modal-contacto .modal-box {
      background:white;
      padding:1.6rem;
      border-radius:10px;
      box-shadow:0 4px 16px rgba(0,0,0,.25);
      width:92%;
      max-width:420px;
      text-align:center;
    }
    #modal-contacto .modal-box h2 { margin:0 0 .6rem 0; color:#087021; font-size:1.15rem; }
    #modal-contacto .cerrar-btn {
      margin-top:1rem;
      background:#087021;
      color:white;
      border:none;
      padding:.55rem 1rem;
      border-radius:6px;
      font-weight:600;
      cursor:pointer;
    }

    /* responsive: en pantallas peque√±as hacemos que las "columnas" se apilen visualmente */
    @media (max-width: 900px) {
      .headers-fijos, .fila { grid-template-columns: 1.2fr 0.9fr 0.9fr 1.4fr 0.9fr 1fr 1fr; font-size:0.9rem; }
    }
    @media (max-width: 700px) {
      .headers-fijos, .fila { grid-template-columns: 1fr; }
      .headers-fijos > div, .fila > div { padding: 6px 0; }
      .headers-fijos { text-align:left; }
      .fila { display:block; }
    }
  </style>
</head>
<body>
<header>
  <img class="logo" src="./SAE_Junta_de_Andalucia_Documentacion.png" alt="Logo SAE">
  <div class="titulos">
    <h1>Buscador de Unidades e Itinerancias</h1>
    <h2>Programa Andaluc√≠a Orienta. SAE Granada 2025-26</h2>
  </div>
</header>

  <main>
    <input type="text" id="search" placeholder="Buscar por entidad, municipio, colectivo... (filtra ambas tablas)" oninput="debounceBuscar()">
    <div id="filtros-campos" style="display:flex; gap:1rem; justify-content:center; margin-top:0.3rem; margin-bottom:0.3rem; font-size:0.9rem;">
      <label><input type="checkbox" id="chkEntidad" checked> Entidad</label>
      <label><input type="checkbox" id="chkMunicipio" checked> Municipio</label>
      <label><input type="checkbox" id="chkColectivo" checked> Colectivo</label>
    </div>

    <div class="tables-wrap">

      <!-- BLOQUE 1: UNIDADES AO -->
      <div>
        <!-- üîî mensaje fallback -->
        <div id="mensajeFallback" style="font-weight:bold; margin-bottom:10px;"></div>   
        
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div class="block-title">Unidades Andaluc√≠a Orienta</div>
        </div>

        <div class="headers-fijos" aria-hidden="true">
          <div>ENTIDAD</div>
          <div>TEL√âFONO</div>
          <div>DIRECCI√ìN UNIDAD</div>
          <div>MUNICIPIO</div>
          <div>COLECTIVO</div>
          <div>OFICINA SAE</div>
          <div>OBSERVACIONES</div>
        </div>

        <div id="contenedor-unidades" class="datos-scroll">
          <div style="padding:1rem; text-align:center;">Cargando datos...</div>
        </div>
      </div>
<br>
      <!-- BLOQUE 2: ITINERANCIAS -->
      <div>
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div class="block-title">Itinerancias</div>
        </div>

        <div class="headers-fijos" aria-hidden="true">
          <div>ENTIDAD</div>
          <div>MUNICIPIO</div>
          <div>D√çAS</div>
          <div>DIRECCI√ìN</div>
          <div>TEL√âFONO</div>
          <div>TECNIC@ ORIENTA</div>
          <div>COLECTIVO</div>
        </div>

        <div id="contenedor-itinerancias" class="datos-scroll">
          <div style="padding:1rem; text-align:center;">Cargando datos...</div>
        </div>
      </div>

    </div> <!-- .tables-wrap -->
  </main>

  <footer>
    ¬© 2025 - Servicio Andaluz de Empleo. Junta de Andaluc√≠a. Servicio de Intermediaci√≥n e Inserci√≥n Laboral de Granada.
    <button class="contacto-btn" onclick="abrirModalContacto()">Contacto</button>
  </footer>

  <!-- MODAL CONTACTO -->
  <div id="modal-contacto" aria-hidden="true">
    <div class="modal-box">
      <h2>Contacto</h2>
      <p style="margin:.6rem 0 0 0; font-size:1rem; color:#333;">
        Para cualquier consulta con el Departamento de Orientaci√≥n del Servicio de Intermediaci√≥n e Inserci√≥n Laboral de Granada:<br><br>
        <a href="mailto:orientacion.gr.sae@juntadeandalucia.es">orientacion.gr.sae@juntadeandalucia.es</a>
      </p>
      <button class="cerrar-btn" onclick="cerrarModalContacto()">Cerrar</button>
    </div>
  </div>

<script>
  // ---------- utilidades ----------
  function normalizeString(s) {
    return (s || "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[^\w\s]/gi, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  // ---------- variables globales ----------
  let mapaMunicipioOficina = {};
  let unidadesRaw = [];
  let itineranciasRaw = [];
  let unidadesMapped = [];   // mapped to keys we display
  let itineranciasMapped = [];

  // ---------- mapping espec√≠fico para Unidades AO (seg√∫n tus claves) ----------
  function mapUnidad(row) {
    // we expect keys: Entidad, Tel√©fono, Direcci√≥n Unidad, Poblaci√≥n, Colectivo, Observaciones, Oficina SAE
    return {
      entidad: row['Entidad'] || row['entidad'] || "",
      telf: row['Tel√©fono'] || row['telefono'] || row['telf'] || "",
      direccion: row['Direcci√≥n Unidad'] || row['Direccion Unidad'] || row['direccion'] || "",
      municipio: row['Poblaci√≥n'] || row['Poblacion'] || row['municipio'] || "",
      colectivo: row['Colectivo'] || row['colectivo'] || "",
      oficina: row['Oficina SAE'] || row['OficinaSAE'] || row['oficina sae'] || "",
      observaciones: row['Observaciones'] || row['observaciones'] || ""
    };
  }

  // ---------- mapping para itinerancias (reutiliza tu mapRow logic) ----------
  // We'll write a simple pickField utility similar to before
  function normalizeKey(k) {
    return normalizeString(k).replace(/\s+/g, "");
  }

  const ALIAS = {
    entidad: ["entidad", "nombreentidad", "nombre", "organizacion", "organizaci√≥n"],
    municipio: ["municipio", "poblacion", "localidad"],
    dias: ["dias", "d√≠as", "periodo", "horario"],
    direccion: ["direccion", "direcci√≥n", "domicilio", "lugar"],
    telf: ["telefono", "tel", "telefono citas", "tel√©fono", "telefono citas", "tel√©fono citas", "telf"],
    tecnico: ["tecnicoorienta", "tecorienta", "tec orienta", "tecnic@ orienta", "tecnic@orienta", "tecnico", "responsable"],
    colectivo: ["colectivo", "publico", "dirigidoa", "dirigido a"]
  };

  function pickField(row, aliasesList) {
    const keys = Object.keys(row);
    for (const k of keys) {
      const nk = normalizeKey(k);
      for (const a of aliasesList) {
        if (nk === normalizeKey(a)) {
          return row[k];
        }
      }
    }
    // fallback: partial match
    for (const k of keys) {
      const nk = normalizeKey(k);
      for (const a of aliasesList) {
        if (nk.includes(normalizeKey(a))) {
          return row[k];
        }
      }
    }
    return "";
  }

  function mapItinerancia(row) {
    return {
      entidad: pickField(row, ALIAS.entidad) || "",
      municipio: pickField(row, ALIAS.municipio) || "",
      dias: pickField(row, ALIAS.dias) || "",
      direccion: pickField(row, ALIAS.direccion) || "",
      telf: pickField(row, ALIAS.telf) || "",
      tecnico: pickField(row, ALIAS.tecnico) || "",
      colectivo: pickField(row, ALIAS.colectivo) || ""
    };
  }

  // ---------- renderers ----------
  function renderUnidades(filtered) {
    const cont = document.getElementById('contenedor-unidades');
    cont.innerHTML = "";
    if (!filtered || filtered.length === 0) {
      cont.innerHTML = `<div class="sin-resultados">Sin resultados</div>`;
      return;
    }
    const fragment = document.createDocumentFragment();
    filtered.forEach(u => {
      const div = document.createElement('div');
      div.className = 'fila';
      div.innerHTML = `
        <div>${escapeHtml(u.entidad)}</div>
        <div>${escapeHtml(u.telf)}</div>
        <div>${escapeHtml(u.direccion)}</div>
        <div>${escapeHtml(u.municipio)}</div>
        <div>${escapeHtml(u.colectivo)}</div>
        <div>${escapeHtml(u.oficina)}</div>
        <div>${escapeHtml(u.observaciones)}</div>
      `;
      fragment.appendChild(div);
    });
    cont.appendChild(fragment);
  }

  function renderItinerancias(filtered) {
    const cont = document.getElementById('contenedor-itinerancias');
    cont.innerHTML = "";
    if (!filtered || filtered.length === 0) {
      cont.innerHTML = `<div class="sin-resultados">Sin resultados</div>`;
      return;
    }
    const fragment = document.createDocumentFragment();
    filtered.forEach(r => {
      const div = document.createElement('div');
      div.className = 'fila';
      div.innerHTML = `
        <div>${escapeHtml(r.entidad)}</div>
        <div>${escapeHtml(r.municipio)}</div>
        <div>${escapeHtml(r.dias)}</div>
        <div>${escapeHtml(r.direccion)}</div>
        <div>${escapeHtml(r.telf)}</div>
        <div>${escapeHtml(r.tecnico)}</div>
        <div>${escapeHtml(r.colectivo)}</div>
      `;
      fragment.appendChild(div);
    });
    cont.appendChild(fragment);
  }

  // escape b√°sico para evitar inyecci√≥n accidental al inyectar strings
  function escapeHtml(s) {
    if (!s && s !== 0) return "";
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'", "&#39;");
  }

  // ---------- carga de JSONs (una sola vez cada uno) ----------
// ---------- carga de JSONs (una sola vez cada uno) ----------
async function loadDataOnce() {
  // show loading placeholders
  document.getElementById('contenedor-unidades').innerHTML = `<div style="padding:1rem;text-align:center;">Cargando datos...</div>`;
  document.getElementById('contenedor-itinerancias').innerHTML = `<div style="padding:1rem;text-align:center;">Cargando datos...</div>`;

  try {
    // <-- CORRECCI√ìN: destructuramos las 3 respuestas aqu√≠
    const [resU, resI, resM] = await Promise.all([
      fetch('./unidadesAO.json'),
      fetch('./itinerancias.json'),
      fetch('./municipios_oficinas.json')
    ]);

    if (!resU.ok) throw new Error('Error cargando unidadesAO.json: ' + resU.status);
    if (!resI.ok) throw new Error('Error cargando itinerancias.json: ' + resI.status);
    if (!resM.ok) throw new Error('Error cargando municipios_oficinas.json: ' + resM.status);

    unidadesRaw = await resU.json();
    itineranciasRaw = await resI.json();
    const municipiosRaw = await resM.json();

    // mapeo
    unidadesMapped = unidadesRaw.map(mapUnidad);
    itineranciasMapped = itineranciasRaw.map(mapItinerancia);

    // ----  map MUNICIPIO ‚Üí OFICINA  ----
    // atenci√≥: tu JSON ten√≠a claves "Municipio" y "Oficina de empleo" seg√∫n lo que pegaste antes
    municipiosRaw.forEach(r=>{
      if (r.Municipio && r["Oficina de empleo"]) {
        mapaMunicipioOficina[ normalizeString(r.Municipio) ] = r["Oficina de empleo"];
      }
    });

    // ordenar itinerancias por municipio y entidad
    itineranciasMapped.sort((a,b)=>{
      const ma = (a.municipio || "").toLowerCase();
      const mb = (b.municipio || "").toLowerCase();
      if (ma === mb) {
        return (a.entidad || "").localeCompare(b.entidad || "");
      }
      return ma.localeCompare(mb);
    });

  } catch (err) {
    console.error(err);
    document.getElementById('contenedor-unidades').innerHTML = `<div class="sin-resultados">Error cargando datos</div>`;
    document.getElementById('contenedor-itinerancias').innerHTML = `<div class="sin-resultados">Error cargando datos</div>`;
    return;
  }

  // initial render with all data
  renderUnidades(unidadesMapped);
  renderItinerancias(itineranciasMapped);
}


  // ---------- b√∫squeda / filtrado ----------
  let debounceTimer;
  function debounceBuscar() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      buscar();
    }, 300);
  }

  function buscar() {
    const q = normalizeString(document.getElementById('search').value);
    const fEntidad   = document.getElementById('chkEntidad').checked;
    const fMunicipio = document.getElementById('chkMunicipio').checked;
    const fColectivo = document.getElementById('chkColectivo').checked;
    
    document.getElementById("mensajeFallback").innerText = "";

    function rowMatch(obj){
      // si no hay texto ‚Üí no filtra nada
      if(q==="") return true;
  
      let cadena = "";
      if(fEntidad)   cadena += " " + (obj.entidad||"");
      if(fMunicipio) cadena += " " + (obj.municipio||"");
      if(fColectivo) cadena += " " + (obj.colectivo||"");
      // normalizamos
      const texto = normalizeString(cadena); //ignora tildes.
      const palabras = q.split(" ").filter(w => w !== "");// todas las palabras tienen que aparecer en alg√∫n punto del texto concatenado
  
      return palabras.every(p => texto.includes(p));
    }
  
    // aplico filtro normal
    const fUn = unidadesMapped.filter(rowMatch);
    const fIt = itineranciasMapped.filter(rowMatch);
    
    // --- fallback B: si 0 y 0, y hay municipio que detectemos ‚Üí cargar oficina
    if (fUn.length===0 && fIt.length===0) {
      const palabras = q.split(" ").filter(w=>w!=="");
      let oficinaDetectada = null;
    
      for (let p of palabras) {
        if (mapaMunicipioOficina[p]) {
          oficinaDetectada = mapaMunicipioOficina[p];
          break;
        }
      }
    
      if (oficinaDetectada) {
        const oficinaNorm = normalizeString(oficinaDetectada);
    
        // unidades ya tienen oficina
        const fallbackUn = unidadesMapped.filter(u=> normalizeString(u.oficina)===oficinaNorm );
    
        // itinerancias ‚Üí sacar oficinas por municipio
        const fallbackIt = itineranciasMapped.filter(i=>{
          const muniNorm = normalizeString(i.municipio);
          const off = mapaMunicipioOficina[muniNorm];
          return off && normalizeString(off)===oficinaNorm;
        });
        
        document.getElementById("mensajeFallback").innerText =
          "Sin coincidencias directas. Mostrando resultados de la oficina: " + oficinaDetectada;
    
        renderUnidades(fallbackUn);
        renderItinerancias(fallbackIt);
        return;
      }
    }
    
    // si NO hay fallback ‚Üí pintar normal
    renderUnidades(fUn);
    renderItinerancias(fIt);
  }

  // ---------- modal contacto (bloquea scroll de fondo) ----------
  function abrirModalContacto() {
    const modal = document.getElementById('modal-contacto');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    modal.setAttribute('aria-hidden','false');
  }
  function cerrarModalContacto() {
    const modal = document.getElementById('modal-contacto');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    modal.setAttribute('aria-hidden','true');
  }
  // cerrar al click fuera
  document.addEventListener('click', function(e){
    const modal = document.getElementById('modal-contacto');
    if (!modal) return;
    if (modal.style.display === 'flex' && e.target === modal) {
      cerrarModalContacto();
    }
  });

  // ---------- start ----------
  document.addEventListener('DOMContentLoaded', () => {
    loadDataOnce();
  });
</script>
</body>
</html>
